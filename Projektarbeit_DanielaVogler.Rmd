---
title: "Detektion von Sepsiserkrankungen in Intensivpatienten"
subtitle: "Projektarbeit im Zertifikatsprogramm \"Medical Data Science\""
author: "Daniela Vogler"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
header-includes:
  \renewcommand{\tablename}{Tabelle}
  \renewcommand{\contentsname}{Inhalt}
output: 
  pdf_document:
  toc: true
  toc_depth: 2
  keep_tex: yes
  number_sections: true
fontsize: 12pt
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  include = FALSE,
  cache = TRUE,
  fig.pos = "H")
```

```{r requirements, include = FALSE}
library(tidyverse)
library(here)
library(kableExtra)
library(grid)
library(gridExtra)
library(reshape)
library(caret)
```

```{r session info, include = TRUE}
sessioninfo::platform_info()$version
subset(data.frame(sessioninfo::package_info()), attached==TRUE, 
       c(package, loadedversion))
```

```{r loading data}
data_complete <- read.csv(here("data/Dataset.csv"))

# Subsample ziehen, um die Datenmenge besser handhaben zu können
set.seed(12345)

n <- round(0.1*length(unique(data_complete$Patient_ID)))

data_sample_index <- data_complete %>% 
  distinct(Patient_ID) %>% 
  sample_n(n)

data_sample <- data_complete %>% 
  filter(Patient_ID %in% data_sample_index$Patient_ID)

var_info <- read.csv2(
  here("data/Datensatzbeschreibung.csv")
  )
```

```{r data structure}
summary(data_sample)
str(data_sample)

# Outcome pro Patient abspeichern
outcome <- data_sample %>% 
  group_by(Patient_ID) %>% 
  mutate(Sepsis = max(SepsisLabel)) %>% 
  ungroup() %>% 
  select(Patient_ID, Sepsis) %>% 
  unique()

table(outcome$Sepsis)
```

```{r data preparation}
data_sample <- data_sample %>% 
  mutate(Gender = factor(Gender, levels = c(0, 1), labels = c("W", "M")),
         Unit1 = factor(Unit1, levels = c(0, 1), labels = c("nein", "ja")),
         Unit2 = factor(Unit2, levels = c(0, 1), labels = c("nein", "ja")),
         SepsisLabel = factor(SepsisLabel, levels = c(0, 1), 
                              labels = c("negativ", "positiv")
                              )
  )

outcome <- outcome %>% 
  mutate(Sepsis = factor(Sepsis, levels = c(0, 1),
                         labels = c("negativ", "positiv")
                         )
         )

# Zur weiteren Verwendung wird jedem Datensatz der Outcome über den gesamten 
# Zeitraum hinzugefügt
data_sample <- merge(data_sample, outcome, by = "Patient_ID")
```

```{r data correlation, fig.height=8, fig.width=12, message=TRUE, warning=FALSE}
data_sample %>% 
  select_if(is.numeric) %>%  
  select(-Patient_ID, -X) %>% 
  GGally::ggcorr(method = c("pairwise.complete.obs", "pearson"),
         label = TRUE, label_size =2, label_alpha = TRUE) + 
  labs(title = "Korrelationskoeffizienten nach Pearson")
```

Baum-basierte Methoden funktionieren auch bei starker Multikollinearität gut, da sukzessive einzelne Variablen für die Splits herangezogen werden. Liefert eine Variable keinen oder kaum Informationsgewinn, weil sie stark mit einer vorher bereits zum Split genutzten Variable korreliert, wird sie nicht verwendet. Daher müssen wir uns hier keine allzu großen Sorgen um die Korrelationen machen. Allerdings sollten starke Kollinearitäten später bei der Interpretation der Entscheidungskriterien berücksichtigt werden. Es ist möglich, dass nicht die eigentlich relevante Variable für einen Split herangezogen wird, sondern eine, die stark mit ihr korreliert ist.

Bei Variablen mit vollständigen linearen Zusammenhang (Korrelationskoeffizient +/- 1) scheint mir allerdings eine Variablenselektion dennoch angeraten.

Hour dient nur zur Information und soll nicht als Einflussvariable verwendet werden. Daher kann sie hier vernachlässigt werden.

```{r Bilirubin}
data_sample %>% 
  filter(is.na(Bilirubin_total) & !is.na(Bilirubin_direct)) %>% 
  summarize(n())

data_sample %>% 
  filter(is.na(Bilirubin_direct) & !is.na(Bilirubin_total)) %>% 
  summarize(n())
```
Da es nur sehr wenige Beobachtungen gibt, in denen das Gesamt-Bilirubin fehlt, aber direkts Bilirubin gemessen wurde, andersherum jedoch einige Beobachtungen existieren, die eine Messung des Gesamt-Bilirubins enthalten, abre keine des direkten Bilirubins, wird die Variable Bilirubin_direct aus dem Datensatz entfernt.

Hämoglobin- und Hämatokrit-Wert entsprechen einander ungefähr, weil die Erythrozyten den Großteil des Gesamtvolumens der Blutzellen ausmachen.

```{r Hct Hgb}
data_sample %>% 
  filter(is.na(Hct) & !is.na(Hgb)) %>% 
  summarize(n())

data_sample %>% 
  filter(is.na(Hgb) & !is.na(Hct)) %>% 
  summarize(n())
```

Ich entscheide daher auch hier nach Vollständigkeit der Beobachtungen und entferne die Variable Hgb aus dem Datensatz.

```{r variable selection}
data_sample <- data_sample %>% 
  select(-Bilirubin_direct, -Hgb)
```

```{r boxplots, include = TRUE, warning = FALSE, fig.height=8, fig.width=10, fig.cap="Boxplots der numerischen Einflussfaktoren"}
# Numerische Einflussfaktoren in Bezug zum temporärer Sepsisstatus
melt_sample <- data_sample %>% 
  select(-Gender, -Unit1, -Unit2, ) %>% 
  melt(., id.vars = c("Patient_ID", "X", "Hour", "SepsisLabel", "Sepsis"))

p <- ggplot(melt_sample, aes(factor(variable), value)) + 
  geom_boxplot(aes(fill = SepsisLabel)) + 
   labs(x = "", y = "") +
  facet_wrap(~variable, scale="free") +
  theme(strip.background = element_blank(), strip.text = element_blank())

p

rm(melt_sample, p)
```

Bei Betrachtung der Boxplots der möglichen numerischen Einflussfaktoren fällt keine Variable durch besonders deutliche Unterschiede zwischen Patienten mit und ohne Sepsis auf.

Da schwerwiegende Erkrankungen durchaus extreme medizinische Werte hervorbringen können, ist es schwierig festzulegen, wann Ausreißer Messfehler sind und daher aus der Betrachtung herausgenommen werden sollten. Zudem sind Baum-basierte Methoden robust gegenüber Ausreißern. Deshalb werden hier nur aus einer Variable wenige offensichtlich falsche Werte entfernt: FiO2 drückt einen Anteil aus und muss daher zwischen 0 und 1 liegen. 

```{r data cleaning}
data_sample %>%
  filter(FiO2 < 0 | FiO2 > 1)

data_sample <- data_sample %>% 
  mutate(FiO2 = case_when(FiO2 >= 0 & FiO2 <= 1 ~ FiO2))
```

```{r creating baseline dataset}
# Es sollen die Messwerte zur Stunde 1 verwendet werden, aber für den Outcome 
# ist der Gesamtzeitraum entscheidend
dataset1 <- data_sample %>% 
  filter(Hour == 1) %>% 
  select(-SepsisLabel)
```

```{r creating onset dataset}
# Es sollen die Beobachtungen zum Zeitpunkt des ersten positiven Labels verwendet
# werden, für Nicht-Sepsispatienten ein zufälliger Zeitpunkt
data_pos <- data_sample %>% 
  filter(SepsisLabel == "positiv") %>% 
  group_by(Patient_ID) %>% 
  mutate(ersteSepsisflag = min(Hour)) %>% 
  ungroup() %>% 
  filter(Hour == ersteSepsisflag) %>% 
  select(-ersteSepsisflag)

tmp_data_neg <- data_sample %>% 
  filter(Sepsis == "negativ") %>% 
  group_by(Patient_ID) %>% 
  summarize(max_Hour = max(Hour),
            selected_Hour = sample (c(1:max_Hour), size=1, replace =F)
            )

data_neg <- data_sample %>% 
  filter(Sepsis == "negativ") %>% 
  merge(., tmp_data_neg, by = "Patient_ID") %>% 
  filter(Hour == selected_Hour) %>% 
  select(-max_Hour, -selected_Hour)
  
  
dataset2 <- union_all(data_pos, data_neg) %>% 
  select(-SepsisLabel)

rm(data_pos, data_neg, tmp_data_neg)
```

```{r creating regression dataset}
# Anstelle der Vital- und Laborwerte sollen die patientenindividuellen Slopes verwendet werden. Wenn ein Patient eine Sepsis entwickelt, wird nur der Zeitraum bis zum ersten positiven Label betrachtet.

# ToDo: Iteration über alle Variablen automatisieren
data_pos <- data_sample %>% 
  filter(SepsisLabel == "positiv") %>% 
  group_by(Patient_ID) %>% 
  mutate(ersteSepsisflag = min(Hour),
         ICULOS_end = min(ICULOS)) %>% 
  distinct(Patient_ID, ersteSepsisflag, ICULOS_end)

data_sub <- data_sample %>% 
  merge(., data_pos, by = "Patient_ID", all.x = TRUE) %>% 
  filter(Sepsis == "negativ" | (ersteSepsisflag > 0 &  Hour <= ersteSepsisflag)) %>% 
    # für ersteSepsisFlag = 0 lässt sich keine Entwicklung aufzeigen
  group_by(Patient_ID) %>% 
  mutate(ICULOS = case_when(!is.na(ICULOS_end) ~ ICULOS_end,
                            TRUE ~ max(ICULOS))) %>% 
  ungroup()

patient_model_HR <- function(df) {
  if (sum(!is.na(df$HR)) < 2) NA else lm(HR ~ Hour, data = df)$coeff[2]}
patient_model_O2Sat <- function(df) {
  if (sum(!is.na(df$O2Sat)) < 2) NA else lm(O2Sat ~ Hour, data = df)$coeff[2]}
patient_model_Temp <- function(df) {
  if (sum(!is.na(df$Temp)) < 2) NA else lm(Temp ~ Hour, data = df)$coeff[2]}
patient_model_SBP <- function(df) {	
  if (sum(!is.na(df$SBP)) < 2) NA else lm(SBP ~ Hour, data = df)$coeff[2]}
patient_model_MAP <- function(df) {
  if (sum(!is.na(df$MAP)) < 2) NA else lm(MAP ~ Hour, data = df)$coeff[2]}
patient_model_DBP <- function(df) {
  if (sum(!is.na(df$DBP)) < 2) NA else lm(DBP ~ Hour, data = df)$coeff[2]}
patient_model_Resp <- function(df) {
  if (sum(!is.na(df$Resp)) < 2) NA else lm(Resp ~ Hour, data = df)$coeff[2]}
patient_model_EtCO2 <- function(df) {
  if (sum(!is.na(df$EtCO2)) < 2) NA else lm(EtCO2 ~ Hour, data = df)$coeff[2]}
patient_model_BaseExcess <- function(df) {
  if (sum(!is.na(df$BaseExcess)) < 2) NA else lm(BaseExcess ~ Hour, data = df)$coeff[2]}
patient_model_HCO3 <- function(df) {
  if (sum(!is.na(df$HCO3)) < 2) NA else lm(HCO3 ~ Hour, data = df)$coeff[2]}
patient_model_FiO2 <- function(df) {
  if (sum(!is.na(df$FiO2)) < 2) NA else lm(FiO2 ~ Hour, data = df)$coeff[2]}
patient_model_pH <- function(df) {
  if (sum(!is.na(df$pH)) < 2) NA else lm(pH ~ Hour, data = df)$coeff[2]}
patient_model_PaCO2 <- function(df) {
  if (sum(!is.na(df$PaCO2)) < 2) NA else lm(PaCO2 ~ Hour, data = df)$coeff[2]}
patient_model_SaO2 <- function(df) {
  if (sum(!is.na(df$SaO2)) < 2) NA else lm(SaO2 ~ Hour, data = df)$coeff[2]}
patient_model_AST <- function(df) {
  if (sum(!is.na(df$AST)) < 2) NA else lm(AST ~ Hour, data = df)$coeff[2]}
patient_model_BUN <- function(df) {
  if (sum(!is.na(df$BUN)) < 2) NA else lm(BUN ~ Hour, data = df)$coeff[2]}
patient_model_Alkalinephos <- function(df) {
  if (sum(!is.na(df$Alkalinephos)) < 2) NA else lm(Alkalinephos ~ Hour, data = df)$coeff[2]}
patient_model_Calcium <- function(df) {
  if (sum(!is.na(df$Calcium)) < 2) NA else lm(Calcium ~ Hour, data = df)$coeff[2]}
patient_model_Chloride <- function(df) {
  if (sum(!is.na(df$Chloride)) < 2) NA else lm(Chloride ~ Hour, data = df)$coeff[2]}
patient_model_Creatinine <- function(df) {
  if (sum(!is.na(df$Creatinine)) < 2) NA else lm(Creatinine ~ Hour, data = df)$coeff[2]}
# patient_model_Bilirubin_direct <- function(df) {
#   if (sum(!is.na(df$Bilirubin_direct)) < 2) NA else lm(Bilirubin_direct ~ Hour, data = df)$coeff[2]}
patient_model_Glucose <- function(df) {
  if (sum(!is.na(df$Glucose)) < 2) NA else lm(Glucose ~ Hour, data = df)$coeff[2]}
patient_model_Lactate <- function(df) {
  if (sum(!is.na(df$Lactate)) < 2) NA else lm(Lactate ~ Hour, data = df)$coeff[2]}
patient_model_Magnesium <- function(df) {
  if (sum(!is.na(df$Magnesium)) < 2) NA else lm(Magnesium ~ Hour, data = df)$coeff[2]}
patient_model_Phosphate <- function(df) {
  if (sum(!is.na(df$Phosphate)) < 2) NA else lm(Phosphate ~ Hour, data = df)$coeff[2]}
patient_model_Potassium <- function(df) {
  if (sum(!is.na(df$Potassium)) < 2) NA else lm(Potassium ~ Hour, data = df)$coeff[2]}
patient_model_Bilirubin_total <- function(df) {
  if (sum(!is.na(df$Bilirubin_total)) < 2) NA else lm(Bilirubin_total ~ Hour, data = df)$coeff[2]}
patient_model_TroponinI <- function(df) {
  if (sum(!is.na(df$TroponinI)) < 2) NA else lm(TroponinI ~ Hour, data = df)$coeff[2]}
patient_model_Hct <- function(df) {
  if (sum(!is.na(df$Hct)) < 2) NA else lm(Hct ~ Hour, data = df)$coeff[2]}
# patient_model_Hgb <- function(df) {
#   if (sum(!is.na(df$Hgb)) < 2) NA else lm(Hgb ~ Hour, data = df)$coeff[2]}
patient_model_PTT <- function(df) {
  if (sum(!is.na(df$PTT)) < 2) NA else lm(PTT ~ Hour, data = df)$coeff[2]}
patient_model_WBC <- function(df) {
  if (sum(!is.na(df$WBC)) < 2) NA else lm(WBC ~ Hour, data = df)$coeff[2]}
patient_model_Fibrinogen <- function(df) {
  if (sum(!is.na(df$Fibrinogen)) < 2) NA else lm(Fibrinogen ~ Hour, data = df)$coeff[2]}
patient_model_Platelets <- function(df) {
  if (sum(!is.na(df$Platelets)) < 2) NA else lm(Platelets ~ Hour, data = df)$coeff[2]}

by_patient <- data_sub %>% 
  group_by(Patient_ID, ICULOS) %>% 
  nest() %>% 
  mutate(slope_HR = map(data, patient_model_HR),
         slope_O2Sat = map(data, patient_model_O2Sat),
         slope_Temp = map(data, patient_model_Temp),
         slope_SBP = map(data, patient_model_SBP),
         slope_MAP = map(data, patient_model_MAP),
         slope_DBP = map(data, patient_model_DBP),
         slope_Resp = map(data, patient_model_Resp),
         slope_EtCO2 = map(data, patient_model_EtCO2),
         slope_BaseExcess = map(data, patient_model_BaseExcess),
         slope_HCO3 = map(data, patient_model_HCO3),
         slope_FiO2 = map(data, patient_model_FiO2),
         slope_pH = map(data, patient_model_pH),
         slope_PaCO2 = map(data, patient_model_PaCO2),
         slope_SaO2 = map(data, patient_model_SaO2),
         slope_AST = map(data, patient_model_AST),
         slope_BUN = map(data, patient_model_BUN),
         slope_Alkalinephos = map(data, patient_model_Alkalinephos),
         slope_Calcium = map(data, patient_model_Calcium),
         slope_Chloride = map(data, patient_model_Chloride),
         slope_Creatinine = map(data, patient_model_Creatinine),
         #slope_Bilirubin_direct = map(data, patient_model_Bilirubin_direct),
         slope_Glucose = map(data, patient_model_Glucose),
         slope_Lactate = map(data, patient_model_Lactate),
         slope_Magnesium = map(data, patient_model_Magnesium),
         slope_Phosphate = map(data, patient_model_Phosphate),
         slope_Potassium = map(data, patient_model_Potassium),
         slope_Bilirubin_total = map(data, patient_model_Bilirubin_total),
         slope_TroponinI = map(data, patient_model_TroponinI),
         slope_Hct = map(data, patient_model_Hct),
         #slope_Hgb = map(data, patient_model_Hgb),
         slope_PTT = map(data, patient_model_PTT),
         slope_WBC = map(data, patient_model_WBC),
         slope_Fibrinogen = map(data, patient_model_Fibrinogen),
         slope_Platelets = map(data, patient_model_Platelets))%>% 
  unnest(c(slope_HR, slope_O2Sat, slope_Temp, slope_SBP, slope_MAP, slope_DBP, 
           slope_Resp, slope_EtCO2, slope_BaseExcess, slope_HCO3, slope_FiO2, 
           slope_pH, slope_PaCO2, slope_SaO2, slope_AST, slope_BUN, 
           slope_Alkalinephos, slope_Calcium, slope_Chloride, slope_Creatinine, 
           slope_Glucose, slope_Lactate, slope_Magnesium, slope_Phosphate,
           slope_Potassium, slope_Bilirubin_total, slope_TroponinI, slope_Hct,
           slope_PTT, slope_WBC, slope_Fibrinogen, slope_Platelets)) %>%  
  select(-data)

dataset3 <- data_sample %>% 
  distinct(Patient_ID, Age, Gender, Unit1, Unit2, HospAdmTime, Sepsis) %>%
  merge(by_patient, by = "Patient_ID", all = FALSE) 

rm(by_patient, data_sub, data_pos)
```

```{r vars description, include = TRUE, echo = FALSE}
knitr::kable(var_info, booktabs = T,
             caption = "Datensatzbeschreibung (Variablen)") %>%
  kable_styling(latex_options = c("striped", "scale_down"),
                position = "center")
```